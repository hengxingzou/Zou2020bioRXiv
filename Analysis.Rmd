---
title: "Analysis for Manuscript: \nStage-mediated priority effects and species life history shape long-term competition dynamics"
author: "Heng-Xing Zou, Sebastian J. Schreiber, Volker H. W. Rudolf"
date: "10/20/2022"
output: html_document
---

# General Notes

- This file, when knitted, produces all figures included in the main text and Supporting Information. Note that the order might differ. 
- Before running, please make sure that this file is under the same folder with `Functions.R`.
- Some chunks may take very long time to run.
- Some chunks require changing certain places in `Functions.R`. Please follow instructions for those specific chunks.
- Please contact the author [Heng-Xing Zou](hz70@rice.edu) for questions or suggestions.

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
source("Functions.R")

# fig_dir = "/Figures"
# if (!dir.exists(fig_dir)) {
#   dir.create(fig_dir)
# }

```

# Data Generation

Data generation could take a long time. To jumpstart, run the following chunk to load the pre-saved environment.

## Shared Parameters

```{r}

delta_s_lst = seq(-4, 4, 1)
init_pop = cbind(c(0, 0, 0, 0, 0, 0, 3), c(0, 0, 0, 0, 0, 0, 3))
para = cbind(c(12, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8), c(12, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8))

B = 0.225
xmid = 0
scal = 0.85

mu = c(0.2, 0.2)
s = 7
n_gens_lst = c(2, 4, 8, 16, 32) # 64
# season_lens = 6*n_gens+1
n_seasons = 50

```

## Stage-mediated Interspecific Competition

Change `generate_amat()` in [Functions.R](Functions.R) accordingly: $\alpha_{11}$ and $\alpha_{22}$ should be constants (`"c"`), $\alpha_{12}$ and $\alpha_{21}$ should be variable (`"v"`).

- Invasion Analysis

```{r}

delta_s_lst = seq(-4, 4, 1)

# Low intraspecific competition, symmetric

lowintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.10), delta_s_lst, var = 0, n_gens_lst)

# Mid intraspecific competition, asymmetric

midintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 0, n_gens_lst)

# High intraspecific competition, symmetric

highintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.12, 0.12), delta_s_lst, var = 0, n_gens_lst)

```

- Calculating ND and RFD

```{r}

nd_rfd = midintra %>% select(inv_i, sensitivity, delta_s, n_gens) %>% pivot_wider(names_from = inv_i, values_from = sensitivity) %>%
  mutate(ND = 1-sqrt(`1`*`2`), RFD = sqrt(`1`/`2`)) %>% 
  mutate(outcome = case_when(RFD > 1-ND & RFD < 1/(1-ND) ~ "3", 
                             RFD > 1-ND & RFD > 1/(1-ND) ~ "2", 
                             RFD < 1-ND & RFD < 1/(1-ND) ~ "1", 
                             RFD < 1-ND & RFD > 1/(1-ND) ~ "4"))

```

- Periodic Environment

```{r}

delta_s_lst = seq(-2, 2, 1)
var2 = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 2, n_gens_lst, periodic = T)

```

## No Stage-mediated Interspecific Competition

Change `generate_amat()` in [Functions.R](Functions.R) accordingly: $\alpha_{11}$, $\alpha_{22}$, $\alpha_{12}$ and $\alpha_{21}$ should all be constants (`"c"`).

- Invasion Analysis

```{r}

delta_s_lst = seq(-4, 4, 1)

# Low intraspecific competition, symmetric

xlowintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.10), delta_s_lst, var = 0, n_gens_lst)

# Mid intraspecific competition, asymmetric

xmidintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 0, n_gens_lst)

# High intraspecific competition, symmetric

xhighintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.12, 0.12), delta_s_lst, var = 0, n_gens_lst)

```

- Calculating ND and RFD

```{r}

xnd_rfd = xmidintra %>% select(inv_i, sensitivity, delta_s, n_gens) %>% pivot_wider(names_from = inv_i, values_from = sensitivity) %>%
  mutate(ND = 1-sqrt(`1`*`2`), RFD = sqrt(`1`/`2`)) %>% 
  mutate(outcome = case_when(RFD > 1-ND & RFD < 1/(1-ND) ~ "3", 
                             RFD > 1-ND & RFD > 1/(1-ND) ~ "2", 
                             RFD < 1-ND & RFD < 1/(1-ND) ~ "1", 
                             RFD < 1-ND & RFD > 1/(1-ND) ~ "4"))

```

- Periodic Environment

```{r}

delta_s_lst = seq(-2, 2, 1)
xvar2 = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 2, n_gens_lst, periodic = T)

```

## Both Stage-mediated Intra- and Interspecific Competition

```{r}

# Low intraspecific competition, symmetric

vlowintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.10), delta_s_lst, var = 0, n_gens_lst)

# Mid intraspecific competition, asymmetric

vmidintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 0, n_gens_lst)

# High intraspecific competition, symmetric

vhighintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.12, 0.12), delta_s_lst, var = 0, n_gens_lst)

```

## Adult Density-dependence

```{r}

adu_dd_midintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 0, n_gens_lst)

xadu_dd_midintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 0, n_gens_lst)

```

# Main Text Figures

If mathematical expressions are not showing correctly, go to Tools -> Global Options -> Graphics, and select backend graphic device as "AGG".

## Figure 2

```{r}

delta_s_lst = seq(-4, 4, 1)

compData = tibble(a12 = comp_coeff(B, scal, xmid, delta_s_lst, "v"), 
                  a21 = comp_coeff(B, -scal, xmid, delta_s_lst, "v"), 
                  pshift = delta_s_lst)

plcomp_inter =
compData %>% 
  pivot_longer(col = a12:a21, names_to = "coefficient", values_to = "values") %>% 
  ggplot(aes(x = pshift, y = values, color = coefficient)) + 
  geom_line() + 
  geom_point(size = 2) + 
  theme_bw() + 
  ggtitle("A") + 
  scale_color_manual(name = "Coefficients", values = color_scheme, labels = c(expression(paste(beta[12])), expression(paste(beta[21])))) +
  scale_x_continuous(name = expression(paste("Initial stage difference (", Delta, "s)")), breaks = delta_s_lst) +
  ylab("Competition coefficients") +
  theme(panel.grid = element_blank()) + theme(axis.text = element_text(size = 15), axis.title = element_text(size = 20), 
                                              legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
                                              plot.title = element_text(size = 20))

n_seasons = 10
n_gens = 2

out = seasons(n_seasons, init_pop, para, c(B, 0.10, 0.12), mean_diff = 2, var = 0, n_gens, periodic = F, return_all = T)

pldyn =
convert_output(out) %>% 
  pivot_longer(col = 1:6, names_to = "stage", values_to = "population") %>% 
  select(-`7`) %>%
  # filter(stage == "6") %>%
  group_by(time, species) %>% 
  summarize(sum(population)) %>% 
  rename(population = `sum(population)`) %>% 
  ggplot(aes(x = time, y = population, color = species)) + 
  geom_line() + 
  theme_bw() + 
  scale_color_manual(values = color_scheme) + 
  ggtitle("B") + 
  scale_x_continuous(name = "Season", breaks = seq(0, (n_gens*(s-1)+3)*n_seasons, n_gens*(s-1)+3), label = seq(0, n_seasons, 1)) +
  # xlim(0, 2*season_len+1)+
  guides(color = guide_legend(title = "Species")) + 
  ylab("Population") +
  theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 20), axis.ticks = element_blank(), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

```

- Save Figure 2

```{r}

ggsave("Figures/Fig2.pdf", plot = (plcomp_inter | pldyn), 
       width = 3600, height = 1200, unit = "px")

```

## Figure 3

- Deterministic (panels A, C)

```{r}

delta_s_lst = seq(-4, 4, 1)

plmid_tra =
midintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = expression(paste(Delta, "s")), breaks = delta_s_lst, label = delta_s_lst) + 
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  geom_rect(aes(xmin = 2.5, ymin = 0.5, xmax = 7.5, ymax = 5.5), color = "black", alpha = 0, size = 1) + 
  # change here; for periodic, guide goes here
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + 
  ggtitle(expression(paste("A. Constant ", Delta, "s"))) +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
        plot.title = element_text(size = 20))

xplmid_tra =
xmidintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = expression(paste(Delta, "s")), breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  geom_rect(aes(xmin = 2.5, ymin = 0.5, xmax = 7.5, ymax = 5.5), color = "black", alpha = 0, size = 1) + 
  # change here 
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme, guide = "none") +
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + 
  ggtitle(expression(paste("C. Constant ", Delta, "s"))) +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

```

- Periodic (Panels B, D)

```{r}

delta_s_lst = seq(-2, 2, 1)

plmid_tra_peri =
  var2 %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = expression(bar(paste(Delta, "s"))), breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "Coexistence", "PFD"), values = c("#a61b29", "#ECB88A", "#577C8A"), guide = "none") +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + 
  ggtitle(expression(paste("B. Periodic ", Delta, "s"))) +
  theme(axis.text = element_text(size = 15), axis.title = element_blank(), axis.ticks = element_blank(), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

xplmid_tra_peri =
  xvar2 %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = expression(bar(paste(Delta, "s"))), breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here 
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme, guide = "none") +
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "PFD"), values = c("#a61b29", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + 
  ggtitle(expression(paste("D. Periodic ", Delta, "s"))) +
  theme(axis.text = element_text(size = 15), axis.title.x = element_text(size = 20), 
        axis.title.y = element_blank(), axis.ticks = element_blank(), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

```

- Save Figure 3

```{r}

ggsave("Figures/Fig3.pdf", 
       plot = plmid_tra + plmid_tra_peri + xplmid_tra + xplmid_tra_peri + 
              plot_layout(widths = c(1.75, 1), guides = "collect"), 
       width = 3000, height = 2250, unit = "px")

```

## Figure 4

- Stage-mediated Interspecific Competition

```{r}

ND_min = -0.3
ND_max = 0.6
RFD_min = -0.6
RFD_max = 0.6

# This is the only panel with legend

midintra_tra_2 =
  generate_baseplot(ND_min, ND_max, RFD_min, RFD_max) + 
  geom_path(data = nd_rfd %>% filter(n_gens == 2), 
            aes(x = ND, y = log10(RFD))) + 
  geom_point(data = nd_rfd %>% filter(n_gens == 2), 
             aes(x = ND, y = log10(RFD), color = outcome), size = 3) + 
  scale_color_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), 
                     values = color_scheme) + 
  ggtitle("A. T = 2 generations") +
  annotate("text", size = 6,
           x = c(0.55, 0.55, -0.24, 0.42, 0.42), 
           y = c(0.16, -0.18, -0.04, 0.33, -0.39), 
           label = c("4", "-4", "0", "2", "-2")) + 
  theme(axis.text = element_text(size = 15), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20),
        axis.ticks = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20))

  
ND_min = -0.2
ND_max = 0.25
RFD_min = -0.25
RFD_max = 0.25

midintra_tra_4 =
  generate_baseplot(ND_min, ND_max, RFD_min, RFD_max) + 
  geom_path(data = nd_rfd %>% filter(n_gens == 4), 
            aes(x = ND, y = log10(RFD))) + 
  geom_point(data = nd_rfd %>% filter(n_gens == 4), 
             aes(x = ND, y = log10(RFD), color = outcome), size = 3) + 
  scale_color_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), 
                     values = color_scheme, guide = "none") + 
  ggtitle("B. T = 4 generations") +
  annotate("text", size = 6,
           x = c(0.23, 0.23, -0.14, 0.12, 0.12),
           y = c(0.09, -0.14, -0.03, 0.08, -0.12),
           label = c("4", "-4", "0", "2", "-2")) + 
  theme(axis.text = element_text(size = 15), 
        axis.title.x = element_blank(), axis.title.y = element_blank(), 
        axis.ticks = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20))

```

- No Stage-mediated Interspecific Competition

```{r}

ND_min = -0.6
ND_max = 0.3
RFD_min = -0.6
RFD_max = 0.6

xmidintra_tra_2 =
  generate_baseplot(ND_min, ND_max, RFD_min, RFD_max) + 
  geom_path(data = xnd_rfd %>% filter(n_gens == 2), 
            aes(x = ND, y = log10(RFD))) + 
  geom_point(data = xnd_rfd %>% filter(n_gens == 2), 
             aes(x = ND, y = log10(RFD), color = outcome), size = 3) + 
  scale_color_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), 
                     values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  ggtitle("C. T = 2 generations") +
  annotate("text", size = 6,
           x = c(0.06, 0.06, -0.47, -0.26, -0.25), 
           y = c(0.25, -0.3, -0.08, 0.07, -0.15), 
           label = c("4", "-4", "0", "2", "-2")) + 
  theme(axis.text = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20),
        axis.ticks = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20))

  
ND_min = -0.55
ND_max = 0.1
RFD_min = -0.2
RFD_max = 0.2

xmidintra_tra_4 =
  generate_baseplot(ND_min, ND_max, RFD_min, RFD_max) + 
  geom_path(data = xnd_rfd %>% filter(n_gens == 4), 
            aes(x = ND, y = log10(RFD))) + 
  geom_point(data = xnd_rfd %>% filter(n_gens == 4), 
             aes(x = ND, y = log10(RFD), color = outcome), size = 3) + 
  scale_color_manual(name = "Outcome", labels = c("PFD"), 
                     values = c("#577C8A"), guide = "none") +
  ggtitle("D. T = 4 generations") + 
  annotate("text", size = 6,
           x = c(-0.31, -0.31, -0.5, -0.38, -0.38),
           y = c(0.09, -0.13, -0.02, 0.06, -0.09),
           label = c("4", "-4", "0", "2", "-2")) +
  theme(axis.text = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_blank(),
        axis.ticks = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20))

```

- Save Figure 4

```{r}

ggsave("Figures/Fig4.pdf", 
       plot = (midintra_tra_2 | midintra_tra_4) / (xmidintra_tra_2 | xmidintra_tra_4) + 
         plot_layout(guides = "collect"), 
       width = 3000, height = 2250, unit = "px")

```

## Figure 5

- Stage-mediated Interspecific Competition

```{r}

nd_rfd_peri = var2 %>% 
  select(inv_i, sensitivity, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = sensitivity) %>%
  mutate(ND = 1-sqrt(`1`*`2`), RFD = sqrt(`1`/`2`)) %>% 
  mutate(outcome = ifelse(1-ND < RFD & RFD < 1/(1-ND), "3", 
                          ifelse(RFD > 1-ND & RFD > 1/(1-ND), "2", 
                                 ifelse(RFD < 1-ND & RFD < 1/(1-ND), "1", "4"))))

# 2 Generations

ND_min = -0.3
ND_max = 0.6
RFD_min = -0.6
RFD_max = 0.6

midintra_tra_peri_2 =
  generate_baseplot(ND_min, ND_max, RFD_min, RFD_max) + 
  geom_path(data = nd_rfd_peri %>% filter(n_gens == 2), 
            aes(x = ND, y = log10(RFD))) + 
  geom_point(data = nd_rfd_peri %>% filter(n_gens == 2), 
             aes(x = ND, y = log10(RFD), color = outcome), size = 3) + 
  scale_color_manual(name = "Outcome", labels = c("1 wins", "Coexistence", "PFD"), 
                     values = c("#a61b29", "#ECB88A", "#577C8A")) + 
  ggtitle("A. T = 2 generations") + 
  annotate("text", size = 6,
           x = c(0.35, 0.14, 0.14),
           y = c(-0.06, 0.14, -0.16),
           label = c("0", "2", "-2")) +
  theme(axis.text = element_text(size = 15), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20),
        axis.ticks = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20))

# 4 Generations

ND_min = -0.2
ND_max = 0.25
RFD_min = -0.25
RFD_max = 0.25

midintra_tra_peri_4 =
  generate_baseplot(ND_min, ND_max, RFD_min, RFD_max) + 
  geom_path(data = nd_rfd_peri %>% filter(n_gens == 4), 
            aes(x = ND, y = log10(RFD))) + 
  geom_point(data = nd_rfd_peri %>% filter(n_gens == 4), 
             aes(x = ND, y = log10(RFD), color = outcome), size = 3) + 
  scale_color_manual(name = "Outcome", labels = c("1 wins", "Coexistence", "PFD"), 
                     values = c("#a61b29", "#ECB88A", "#577C8A"), guide = "none") + 
  ggtitle("B. T = 4 generations") +
  annotate("text", size = 6,
           x = c(0.13, 0.04, 0.04),
           y = c(-0.03, 0.05, -0.09),
           label = c("0", "2", "-2")) +
  theme(axis.text = element_text(size = 15), 
        axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.ticks = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20))

```

- No Stage-mediated Interspecific Competition

```{r}

xnd_rfd_peri = xvar2 %>% 
  select(inv_i, sensitivity, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = sensitivity) %>%
  mutate(ND = 1-sqrt(`1`*`2`), RFD = sqrt(`1`/`2`)) %>% 
  mutate(outcome = ifelse(1-ND < RFD & RFD < 1/(1-ND), "3", 
                          ifelse(RFD > 1-ND & RFD > 1/(1-ND), "2", 
                                 ifelse(RFD < 1-ND & RFD < 1/(1-ND), "1", "4"))))

ND_min = -0.6
ND_max = 0.3
RFD_min = -0.6
RFD_max = 0.6

xmidintra_tra_peri_2 =
  generate_baseplot(ND_min, ND_max, RFD_min, RFD_max) + 
  geom_path(data = xnd_rfd_peri %>% filter(n_gens == 2), 
            aes(x = ND, y = log10(RFD))) + 
  geom_point(data = xnd_rfd_peri %>% filter(n_gens == 2), 
             aes(x = ND, y = log10(RFD), color = outcome), size = 3) + 
  scale_color_manual(name = "Outcome", labels = c("1 wins", "PFD"), 
                     values = c("#a61b29", "#577C8A"), guide = "none") +
  ggtitle("C. T = 2 generations") +
  annotate("text", size = 6,
           x = c(-0.30, -0.22, -0.22),
           y = c(-0.04, 0.17, -0.18),
           label = c("0", "2", "-2")) +
  theme(axis.text = element_text(size = 15), 
        axis.title.y = element_text(size = 20), axis.title.x = element_text(size = 20),
        axis.ticks = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20))

  
ND_min = -0.55
ND_max = 0.1
RFD_min = -0.2
RFD_max = 0.2

xmidintra_tra_peri_4 =
  generate_baseplot(ND_min, ND_max, RFD_min, RFD_max) + 
  geom_path(data = xnd_rfd_peri %>% filter(n_gens == 8), 
            aes(x = ND, y = log10(RFD))) + 
  geom_point(data = xnd_rfd_peri %>% filter(n_gens == 8), 
             aes(x = ND, y = log10(RFD), color = outcome), size = 3) + 
  scale_color_manual(name = "Outcome", labels = c("PFD"), 
                     values = c("#577C8A"), guide = "none") +
  ggtitle("D. T = 4 generations") +
  annotate("text", size = 6,
           x = c(-0.44, -0.4, -0.4),
           y = c(-0.015, 0.04, -0.06),
           label = c("0", "2", "-2")) +
  theme(axis.text = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_blank(),
        axis.ticks = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20))

```

- Save Figure 5

```{r}

ggsave("Figures/Fig5.pdf", 
       plot = (midintra_tra_peri_2 | midintra_tra_peri_4) / (xmidintra_tra_peri_2 | xmidintra_tra_peri_4) + 
         plot_layout(guides = "collect"), 
       width = 3000, height = 2250, unit = "px")

```

# Appendix II

## Data Generation

```{r}

n_gens_lst = c(2, 4, 8, 16, 32, 64)

# Stage-mediated interspecific competition

long_midintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 0, n_gens_lst)

# No stage-mediated interspecific competition

xlong_midintra = invasion_multi(n_seasons, init_pop, para, c(B, 0.10, 0.12), delta_s_lst, var = 0, n_gens_lst)

```

```{r}

delta_s_lst = seq(-4, 4, 1)

pllong_midintra =
long_midintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  mutate(delta_s = rep(seq(-4, 4, 1), 6)) %>%
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = expression(paste(Delta, "s")), breaks = delta_s_lst, label = c("-1/3", "-1/4", "-1/6", "-1/12", "0", "1/12", "1/6", "1/4", "1/3")) + 
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here; for periodic, guide goes here
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + 
  ggtitle(expression(paste("A"))) +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
        plot.title = element_text(size = 20))

xpllong_midintra =
xlong_midintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  mutate(delta_s = rep(seq(-4, 4, 1), 6)) %>%
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = expression(paste(Delta, "s")), breaks = delta_s_lst, label = c("-1/3", "-1/4", "-1/6", "-1/12", "0", "1/12", "1/6", "1/4", "1/3")) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme, guide = "none") +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + 
  ggtitle(expression(paste("B"))) +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

```

## Figure S1

```{r}

ggsave("Figures/FigS1.png", plot = pllong_midintra / xpllong_midintra + plot_layout(guides = "collect"), 
       width = 2250, height = 2250, unit = "px")

```

# Appendix III

## Figure S2

```{r}

pllow_tra =
lowintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  # mutate(delta_s = rep(seq(-4, 4, 1), 6)) %>%
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + ggtitle("A") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

plhigh_tra =
highintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  # mutate(delta_s = rep(seq(-4, 4, 1), 6)) %>%
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme, guide = "none") +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + ggtitle("B") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

```

```{r}

ggsave("Figures/FigS2.png", plot = pllow_tra / plhigh_tra + plot_layout(guides = "collect"), 
       width = 2250, height = 2250, unit = "px")

```

## Figure S3

```{r}

delta_s_lst = seq(-4, 4, 1)

pladu_dd =
adu_dd_midintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = expression(paste(Delta, "s")), breaks = delta_s_lst, label = delta_s_lst) + 
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here; for periodic, guide goes here
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + 
  ggtitle("A") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
        plot.title = element_text(size = 20))

xpladu_dd =
xadu_dd_midintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = expression(paste(Delta, "s")), breaks = delta_s_lst, label = delta_s_lst) + 
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here; for periodic, guide goes here
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "PFD"), values = c("#a61b29", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + 
  ggtitle("B") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
        plot.title = element_text(size = 20))

```

```{r}

ggsave("Figures/FigS3.png", plot = pladu_dd / xpladu_dd + plot_layout(guides = "collect"), 
       width = 2250, height = 2250, unit = "px")

```

# Appendix IV

Change `generate_amat()` in [Functions.R](Functions.R) accordingly: $\alpha_{11}$, $\alpha_{22}$, $\alpha_{12}$ and $\alpha_{21}$ should all be variable (`"v"`).

## Competition-phenology Function

```{r}

delta_s_lst = seq(-4, 4, 1)
alpha = c(0.225, 0.10, 0.12)
scal = 0.85
xmid = 0

compData = tibble(a12 = comp_coeff(alpha[1], scal, xmid, delta_s_lst, "v"), a21 = comp_coeff(alpha[1], -scal, xmid, delta_s_lst, "v"), 
                  a11 = comp_coeff(alpha[2], scal, xmid, delta_s_lst, "v"), 
                  a22 = comp_coeff(alpha[3], scal, xmid, delta_s_lst, "v"), pshift = delta_s_lst)

plcomp_both =
compData %>% pivot_longer(col = a12:a22, names_to = "coefficient", values_to = "values") %>% 
  ggplot(aes(x = pshift, y = values, color = coefficient)) + 
  geom_line(aes(linetype = coefficient)) + geom_point(aes(shape = coefficient), size = 2) + 
  theme_bw() + 
  scale_color_manual(name = "Coefficients", values = c("#c66d76", "#6a121b", "#097180", "#65ccdc"), 
                     labels = c(expression(paste(alpha[11])), expression(paste(beta[12])), 
                                expression(paste(beta[21])), expression(paste(alpha[22])))) +
  scale_shape_manual(name = "Coefficients", values = c(17, 16, 16, 17), 
                     labels = c(expression(paste(alpha[11])), expression(paste(beta[12])), 
                                expression(paste(beta[21])), expression(paste(alpha[22])))) + 
  scale_linetype_manual(name = "Coefficients", values = c(8, 1, 1, 8), 
                        labels = c(expression(paste(alpha[11])), expression(paste(beta[12])), 
                                expression(paste(beta[21])), expression(paste(alpha[22])))) +
  ylab("") + scale_x_continuous(name = "Initial stage difference", breaks = delta_s_lst) + ylab("Competition coefficients") +
  theme(panel.grid = element_blank()) + theme(axis.text = element_text(size = 15), axis.title = element_text(size = 20), 
                                                    legend.text = element_text(size = 17), legend.title = element_text(size = 20))

```

## Figure S4

```{r}

ggsave("Figures/FigS4.png", plot = plcomp_both, 
       width = 2000, height = 1200, unit = "px")

```

## Invasion Analysis

```{r}

vpllow = 
vlowintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = ifelse(`1`>0 & `2`>0, 3, 
                          ifelse(`1`>0 & `2`<0, 1, 
                                 ifelse(`1`<0 & `2`>0, 2, 4)))) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme, guide = "none") +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + ggtitle("A") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), axis.title = element_blank(),  
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

vplmid = 
vmidintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = ifelse(`1`>0 & `2`>0, 3, 
                          ifelse(`1`>0 & `2`<0, 1, 
                                 ifelse(`1`<0 & `2`>0, 2, 4)))) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme, guide = "none") +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A")) +
  theme(panel.grid.major = element_blank()) + ggtitle("B") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

vplhigh = 
vhighintra %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = ifelse(`1`>0 & `2`>0, 3, 
                          ifelse(`1`>0 & `2`<0, 1, 
                                 ifelse(`1`<0 & `2`>0, 2, 4)))) %>% 
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens_lst, label = n_gens_lst) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme, guide = "none") +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + ggtitle("C") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.y = element_blank(), axis.title.x = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

```

## Figure S5

```{r}

ggsave("Figures/FigS5.png", plot = vpllow / vplmid / vplhigh + plot_layout(guides = "collect"), 
       width = 2250, height = 3375, unit = "px")

```

# Appendix V

## Stage Distribution

```{r}

n_seasons = 2
n_gens = 2
mean_diff = -4

convert_output(seasons(n_seasons, init_pop, para, c(B, 0.10, 0.12), mean_diff, var = 0, n_gens)) %>% 
  pivot_longer(1:7, names_to = "stage", values_to = "population") %>% 
  pivot_wider(names_from = species, values_from = population) %>% 
  filter(stage != 7) %>% 
  ggplot() + 
  geom_line(aes(x = time, y = log(`1`+1), color = stage)) + 
  scale_color_manual(values = shades_xch) + 
  geom_line(aes(x = time, y = log(`2`+1), color = stage), linetype = 2) +
  scale_color_manual(values = shades_kql) +
  xlim(0, 24) +
  ylim(0, 2.5) +
  theme_bw()

```

## Total Adult Population

- Stage-mediated Interspecific Competition

```{r}

B = 0.225
scal = 0.85
xmid = 0

# init_pop[, 1] = 0
# stabledist(50, 2500, init_pop, para, c(B, 0.10, 0.12), mean_diff = 0, n_gens = 2)

adult_all = data.frame()
for (ds in -(0:4)) {
  for (n_gens in c(2, 8)) {
    season_len = n_gens*(s-1)+abs(ds)+1
    adult = convert_output(seasons(20, adu, para, c(B, 0.10, 0.10), ds, var = 0, n_gens)) %>% 
            mutate(season_no = (time %/% season_len) + 1) %>% 
            group_by(species, season_no) %>% summarize(adult = sum(`6`)) %>%
            mutate(delta_s = ds, n_gens = n_gens)
    adult_all = rbind(adult_all, adult)
  }
}

adult_all %>% 
  filter(species == 1) %>% 
  ggplot(aes(x = season_no, y = log(adult+1), color = factor(delta_s))) + geom_line() + 
  geom_point(size = 3, alpha = 0.5) + 
  scale_color_manual(values = shades_xch, name = expression(paste(Delta, "s"))) + 
  scale_shape_manual(name = "T", values = c(16, 17)) + 
  scale_linetype_manual(name = "T", values = c(1, 8)) + ylab("log(sum(adult population)+1)") + 
  scale_x_continuous(name = "Number of seasons", breaks = c(1, 5, 10, 15), limits = c(1, 15)) +
  facet_grid( ~ n_gens, scales = "fixed",
             labeller = labeller(n_gens = c(`2`="T=2 generations", `8`="T=8 generations"))) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.text = element_text(size = 15), axis.title = element_text(size = 20), 
        axis.ticks.y = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
        strip.text = element_text(size = 15))

# plavgadp =
adult_all %>% 
  filter(species == 2) %>% 
  ggplot(aes(x = season_no, y = log(adult+1), color = factor(delta_s))) + geom_line() + 
  geom_point(size = 3, alpha = 0.5) + 
  scale_color_manual(values = shades_kql, name = expression(paste(Delta, "s"))) + 
  scale_shape_manual(name = "T", values = c(16, 17)) + 
  scale_linetype_manual(name = "T", values = c(1, 8)) + ylab("log(sum(adult population)+1)") + 
  scale_x_continuous(name = "Number of seasons", breaks = c(1, 5, 10, 15), limits = c(1, 15)) +
  facet_grid( ~ n_gens, scales = "free_y", 
             labeller = labeller(n_gens = c(`2`="T=2 generations", `8`="T=8 generations"))) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.text = element_text(size = 15), axis.title = element_text(size = 20), 
        axis.ticks.y = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
        strip.text = element_text(size = 15))

```

- No Stage-mediated Interspecific Competition

```{r}

B = 0.225
scal = 0.85
xmid = 0

xadult_all = data.frame()
for (ds in -(0:4)) {
  for (n_gens in c(2, 8)) {
    season_len = n_gens*(s-1)+abs(ds)+1
    adult = convert_output(seasons(20, init_pop, para, c(B, 0.10, 0.10), ds, var = 0, n_gens)) %>% 
            mutate(season_no = (time %/% season_len) + 1) %>% 
            group_by(species, season_no) %>% summarize(adult = sum(`6`)) %>%
            mutate(delta_s = ds, n_gens = n_gens)
    xadult_all = rbind(xadult_all, adult)
  }
}

xadult_all %>% 
  filter(species == 1) %>% 
  ggplot(aes(x = season_no, y = log(adult+1), color = factor(delta_s))) + geom_line() + 
  geom_point(size = 3, alpha = 0.5) + 
  scale_color_manual(values = shades_xch, name = expression(paste(Delta, "s"))) + 
  scale_shape_manual(name = "T", values = c(16, 17)) + 
  scale_linetype_manual(name = "T", values = c(1, 8)) + ylab("log(sum(adult population)+1)") + 
  scale_x_continuous(name = "Number of seasons", breaks = c(1, 5, 10, 15), limits = c(1, 15)) +
  facet_grid( ~ n_gens, 
             labeller = labeller(n_gens = c(`2`="T=2 generations", `8`="T=8 generations"))) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.text = element_text(size = 15), axis.title = element_text(size = 20), 
        axis.ticks.y = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
        strip.text = element_text(size = 15))

# plavgadp =
xadult_all %>% 
  filter(species == 2) %>% 
  ggplot(aes(x = season_no, y = log(adult+1), color = factor(delta_s))) + geom_line() + 
  geom_point(size = 3, alpha = 0.5) + 
  scale_color_manual(values = shades_kql, name = expression(paste(Delta, "s"))) + 
  scale_shape_manual(name = "T", values = c(16, 17)) + 
  scale_linetype_manual(name = "T", values = c(1, 8)) + ylab("log(sum(adult population)+1)") + 
  scale_x_continuous(name = "Number of seasons", breaks = c(1, 5, 10, 15), limits = c(1, 15)) +
  facet_grid( ~ n_gens, 
             labeller = labeller(n_gens = c(`2`="T=2 generations", `8`="T=8 generations"))) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.text = element_text(size = 15), axis.title = element_text(size = 20), 
        axis.ticks.y = element_blank(), plot.title = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), 
        strip.text = element_text(size = 15))

```


```{r}

delta_s_lst = seq(-4, 4, 1)

# pl_highfec =
highfec %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  # mutate(delta_s = rep(seq(-4, 4, 1), 6)) %>%
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens*6+1, label = n_gens) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + ggtitle("A") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

# xpl_highfec =
xhighfec %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  # mutate(delta_s = rep(seq(-4, 4, 1), 6)) %>%
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens*6+1, label = n_gens) +
  # change here 
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + ggtitle("B") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

```

```{r}

delta_s_lst = seq(-4, 4, 1)

# pladu_dd =
adu_dd %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  # mutate(delta_s = rep(seq(-4, 4, 1), 6)) %>%
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens*6+1, label = n_gens) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + ggtitle("A") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

# xpladu_dd =
xadu_dd %>% select(inv_i, lambda_ij, delta_s, n_gens) %>% 
  pivot_wider(names_from = inv_i, values_from = lambda_ij) %>% 
  mutate(outcome = case_when(`1` > 0 & `2` > 0 ~ 3, 
                             `1` > 0 & `2` < 0 ~ 1, 
                             `1` < 0 & `2` > 0 ~ 2, 
                             `1` < 0 & `2` < 0 ~ 4)) %>% 
  # mutate(delta_s = rep(seq(-4, 4, 1), 6)) %>%
  ggplot(aes(x = as.factor(delta_s), y = as.factor(n_gens), fill = factor(outcome))) + geom_tile(color = "white") + theme_bw() + 
  scale_x_discrete(name = "Initial stage difference", breaks = delta_s_lst, label = delta_s_lst) +
  scale_y_discrete(name = "# Generations per season", breaks = n_gens*6+1, label = n_gens) +
  # change here 
  scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "Coexistence", "PFD"), values = color_scheme) +
  # scale_fill_manual(name = "Outcome", labels = c("1 wins", "2 wins", "PFD"), values = c("#a61b29", "#0eb0c9", "#577C8A"), guide = "none") +
  theme(panel.grid.major = element_blank()) + ggtitle("B") +
  theme(axis.text = element_text(size = 15), axis.ticks = element_blank(), 
        axis.title.x = element_blank(), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), plot.title = element_text(size = 20))

```
